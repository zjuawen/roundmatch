# RustFS 对象存储迁移完成说明

## ✅ 已完成的修改

### 1. 新增文件

- ✅ `server/src/config/storage.config.js` - RustFS 配置模块
- ✅ `server/src/utils/storage.js` - 存储操作工具函数
- ✅ `server/RUSTFS配置说明.md` - 详细配置文档

### 2. 修改的文件

- ✅ `server/src/controllers/mediaservice.js` - 已切换为使用 RustFS 上传
- ✅ `server/package.json` - 已添加 AWS SDK v3 依赖

### 3. 核心变更

**上传逻辑变更：**
- ❌ 旧方式：`fs.renameSync()` 保存到本地目录
- ✅ 新方式：`uploadFile()` 上传到 RustFS 对象存储

**文件 URL 格式：**
- 旧格式：`http://roundmatch.microripples.cn/uploads/clubicons/icon-xxx.png`
- 新格式：`http://localhost:9000/roundmatch-uploads/clubicons/icon-xxx.png`

## 🚀 下一步操作

### 步骤 1: 安装依赖

```bash
cd server
npm install
```

或使用 yarn：

```bash
cd server
yarn install
```

### 步骤 2: 配置环境变量

在 `server/.env` 文件中添加：

```env
# RustFS 对象存储配置
RUSTFS_ENDPOINT=http://localhost:9000
RUSTFS_ACCESS_KEY=minioadmin
RUSTFS_SECRET_KEY=minioadmin
RUSTFS_BUCKET=roundmatch-uploads
RUSTFS_REGION=us-east-1
RUSTFS_USE_SSL=false
```

### 步骤 3: 启动 RustFS 服务

**使用 Docker（推荐）：**

```bash
docker run -d \
  --name rustfs \
  -p 9000:9000 \
  -p 9001:9001 \
  -e "MINIO_ROOT_USER=minioadmin" \
  -e "MINIO_ROOT_PASSWORD=minioadmin" \
  -v /path/to/data:/data \
  minio/minio server /data --console-address ":9001"
```

**访问控制台：**
- 控制台地址：http://localhost:9001
- 用户名：minioadmin
- 密码：minioadmin

### 步骤 4: 创建存储桶

1. 登录 RustFS 控制台
2. 点击 "Create Bucket"
3. 输入名称：`roundmatch-uploads`
4. 设置访问策略为公开读取（如果需要）

### 步骤 5: 启动应用

```bash
cd server
npm start
```

或开发模式：

```bash
npm run dev
```

### 步骤 6: 测试上传

使用 Postman 或 curl 测试：

```bash
curl -X POST http://localhost:8300/api/mediaService?action=upload&type=icon \
  -F "file=@/path/to/test-image.png"
```

## 📝 注意事项

1. **临时文件清理**
   - 上传成功后会自动删除 multer 创建的临时文件
   - 如果上传失败，也会尝试清理临时文件

2. **错误处理**
   - 所有错误都会记录到控制台日志
   - 上传失败时会抛出错误，由错误处理中间件处理

3. **兼容性**
   - 新上传的文件使用 RustFS URL
   - 历史文件仍使用旧 URL（如果需要迁移，请参考迁移脚本）

4. **生产环境**
   - 修改默认的访问密钥
   - 启用 SSL/TLS
   - 配置适当的存储桶策略
   - 设置监控和告警

## 🔍 验证清单

- [ ] 依赖已安装（`@aws-sdk/client-s3`, `@aws-sdk/s3-request-presigner`）
- [ ] 环境变量已配置
- [ ] RustFS 服务已启动
- [ ] 存储桶已创建
- [ ] 应用服务器已启动
- [ ] 文件上传功能测试通过
- [ ] 文件可以正常访问

## 🐛 常见问题

### Q: 连接 RustFS 失败？

A: 检查：
1. RustFS 服务是否运行：`docker ps` 或检查服务状态
2. 端口是否正确：默认 9000
3. 网络连接是否正常
4. 防火墙设置

### Q: 认证失败？

A: 检查：
1. `RUSTFS_ACCESS_KEY` 和 `RUSTFS_SECRET_KEY` 是否正确
2. RustFS 服务中的用户凭据是否匹配

### Q: 存储桶不存在？

A: 
1. 确认存储桶已创建
2. 检查 `RUSTFS_BUCKET` 环境变量
3. 确认存储桶名称拼写正确

### Q: 文件上传后无法访问？

A: 检查：
1. 存储桶策略是否允许公开读取
2. URL 格式是否正确
3. RustFS 服务是否正常运行

## 📚 相关文档

- 详细配置说明：`RUSTFS配置说明.md`
- 迁移方案评估：`对象存储迁移方案评估.md`
